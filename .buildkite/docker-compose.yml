version: '3.5'

services:
  build:
    build:
      context: .
      dockerfile: Dockerfile-compile
    volumes:
      - ../:/work:cached
      - ~/gocache:/gocache
      - ~/gomodcache:/gomodcache
    working_dir: /work
    environment:
      - BUILDKITE_BUILD_NUMBER
      - BUILDKITE_JOB_ID
      - "BUILDKITE_AGENT_TAGS=queue=default"
      - "BUILDKITE_BUILD_PATH=/buildkite"
      - GOCACHE=/gocache
      - GOMODCACHE=/gomodcache
      - BUILDKITE_PARALLEL_JOB
      - BUILDKITE_PARALLEL_JOB_COUNT
      - BUILDKITE_BUILD_ID
      - BUILDKITE_SPLITTER_RSPEC_TOKEN     # token for the splitter suite
      - BUILDKITE_SPLITTER_MODE            # splitting mode
      - BUILDKITE_SPLITTER_BASE_URL        # url for fetching test plan
  release:
    build:
      context: .
      dockerfile: Dockerfile-release
