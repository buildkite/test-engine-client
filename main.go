// bktec fetches and runs test plans generated by Buildkite
// Test Engine.
package main

import (
	"context"
	"errors"
	"fmt"
	"os"
	"os/exec"

	"github.com/buildkite/test-engine-client/internal/command"
	"github.com/buildkite/test-engine-client/internal/config"
	"github.com/buildkite/test-engine-client/internal/debug"
	"github.com/buildkite/test-engine-client/internal/version"
	"github.com/urfave/cli/v3"
)

var cfg = config.New()

func main() {
	if err := cliCommand.Run(context.Background(), os.Args); err != nil {
		logErrorAndExit(err)
	}
}

func run(ctx context.Context, cmd *cli.Command) error {
	debug.SetDebug(cmd.Bool("debug"))

	if err := cfg.ValidateForRun(); err != nil {
		return fmt.Errorf("invalid configuration...\n%w", err)
	}

	return command.Run(ctx, &cfg, cmd.String("files"))
}

func plan(ctx context.Context, cmd *cli.Command) error {
	debug.SetDebug(cmd.Bool("debug"))
	debug.SetOutput(os.Stderr)

	if err := cfg.ValidateForPlan(); err != nil {
		return fmt.Errorf("invalid configuration...\n%w", err)
	}

	if cmd.Bool("json") {
		return command.Plan(ctx, &cfg, cmd.String("files"), command.PlanOutputJSON, "")
	} else {
		return command.Plan(ctx, &cfg, cmd.String("files"), command.PlanOutputPipelineUpload, cmd.String("pipeline-upload"))
	}
}

func printVersion(ctx context.Context, cmd *cli.Command, versionFlag bool) error {
	// Flag will be true if called with `bktec [...] --version`
	if !versionFlag {
		return nil
	}
	fmt.Printf("bktec %s\n", version.Version)
	os.Exit(0)
	return nil
}

func logErrorAndExit(err error) {
	fmt.Fprintln(os.Stderr, err)

	exitError := new(exec.ExitError)
	if errors.As(err, &exitError) {
		// If error wraps an exitError exit with the specified code ...
		os.Exit(exitError.ExitCode())
	} else {
		// otherwise exit code 16
		os.Exit(16)
	}
}
