#!/usr/bin/env bash

# install pact-go as a dev dependency
go get github.com/pact-foundation/pact-go/v2

# install the `pact-go` CLI
go install github.com/pact-foundation/pact-go/v2

go install gotest.tools/gotestsum@v1.8.0

# Check if asdf is installed and being used for Go
if command -v asdf &> /dev/null && asdf current golang &> /dev/null; then
  echo "🔄 Reshimming asdf golang..."
  asdf reshim golang
fi

# download and install the required libraries.
# TODO if pact-go check return non- zero then install it
if ! pact-go check &> /dev/null; then
  echo "🔄 Installing pact-go dependencies..."
  sudo pact-go -l DEBUG install
else
  echo "✅ pact-go dependencies already installed"
fi

echo "🛠️ Installing dependencies for sample projects..."

pushd ./internal/runner/testdata || exit 1
# if yarn is available, use it to install dependencies
# otherwise, use npm
if command -v yarn &> /dev/null
then
  yarn install
else
  npm install
fi
popd || exit 1

# Install Playwright dependencies
pushd ./internal/runner/testdata/playwright || exit 1
npx playwright install
npx playwright install-deps
popd || exit 1

# Install Cypress dependencies
pushd ./internal/runner/testdata/cypress || exit 1
npx cypress install
npx cypress verify
popd || exit 1

# Install RSpec dependencies
pushd ./internal/runner/testdata/rspec || exit 1
bundle install
popd || exit 1

# Install Cucumber dependencies
pushd ./internal/runner/testdata/cucumber || exit 1
bundle install
popd || exit 1

# Install various python things, dependencies for pytest test cases
if [ -n "$VIRTUAL_ENV" ]; then
  echo "Python virtual environment is active: $VIRTUAL_ENV"
else
  echo "No python virtual environment active, creating .venv..."
  echo "You may have to activate the venv by yourself to make it work!"
  echo "  source .venv/bin/activate"
  python -m venv .venv && source .venv/bin/activate
fi
pip install pytest
pip install buildkite-test-collector==0.2.0
curl --proto '=https' --tlsv1.2 -fsSL https://static.pantsbuild.org/setup/get-pants.sh | bash

echo "💖 Everything is fantastic!"
